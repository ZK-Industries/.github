name: Check and Block Repos Without Code Style Workflow

on:
  schedule:
    # Ejecutar todos los lunes a las 9:00 AM
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  check-and-block-repos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check and block repositories without code-style-check.yml
        env:
          GH_TOKEN: ${{ secrets.ORG_TOKEN }}
          ORG_NAME: ${{ github.repository_owner }}
        run: |
          echo "# Reporte de Bloqueo de Repositorios" > report.md
          echo "Fecha: $(date)" >> report.md
          echo "" >> report.md
          
          missing_repos=()
          blocked_repos=()
          already_blocked=()
          compliant_repos=()
          
          # Obtener lista de todos los repositorios de la organizaciÃ³n
          repos=$(gh repo list "$ORG_NAME" --limit 1000 --json name,isArchived --jq '.[] | select(.isArchived == false) | .name')
          
          total=0
          missing=0
          
          for repo in $repos; do
            total=$((total + 1))
            echo "========================================="
            echo "Verificando: $ORG_NAME/$repo"
            
            # Verificar si existe el archivo code-style-check.yml
            if gh api "repos/$ORG_NAME/$repo/contents/.github/workflows/code-style-check.yml" >/dev/null 2>&1; then
              compliant_repos+=("$repo")
              echo "âœ… Tiene code-style-check.yml"
              
              # Opcional: Remover bloqueo si ya estÃ¡ conforme
              echo "  Verificando si tiene restricciones previas..."
              protection=$(gh api "repos/$ORG_NAME/$repo/branches/main/protection" 2>/dev/null || echo "")
              
              if [ -n "$protection" ]; then
                echo "  â„¹ï¸  El repo tiene protecciones configuradas (manteniÃ©ndolas)"
              fi
              
            else
              missing_repos+=("$repo")
              missing=$((missing + 1))
              echo "âŒ NO tiene code-style-check.yml - APLICANDO BLOQUEO"
              
              # Verificar si ya tiene protecciÃ³n de rama
              has_protection=$(gh api "repos/$ORG_NAME/$repo/branches/main/protection" 2>/dev/null && echo "yes" || echo "no")
              
              if [ "$has_protection" = "yes" ]; then
                echo "  â„¹ï¸  El repo ya tiene protecciones (actualizando)"
                already_blocked+=("$repo")
              fi
              
              # Aplicar protecciÃ³n de rama en main/master
              for branch in main master; do
                # Verificar si la rama existe
                if gh api "repos/$ORG_NAME/$repo/branches/$branch" >/dev/null 2>&1; then
                  echo "  ðŸ”’ Aplicando protecciÃ³n en rama: $branch"
                  
                  # Configurar protecciÃ³n de rama
                  gh api \
                    --method PUT \
                    "repos/$ORG_NAME/$repo/branches/$branch/protection" \
                    -f required_status_checks[strict]=true \
                    -f required_status_checks[contexts][]=code-style-check \
                    -f enforce_admins=false \
                    -f required_pull_request_reviews[required_approving_review_count]=1 \
                    -f required_pull_request_reviews[dismiss_stale_reviews]=true \
                    -f restrictions=null \
                    2>/dev/null && echo "  âœ… ProtecciÃ³n aplicada en $branch" || echo "  âš ï¸  Error al aplicar protecciÃ³n en $branch"
                  
                  blocked_repos+=("$repo")
                  break
                fi
              done
              
              # Crear issue en el repositorio bloqueado
              echo "  ðŸ“ Creando issue de notificaciÃ³n..."
              gh issue create \
                --repo "$ORG_NAME/$repo" \
                --title "ðŸš¨ Repositorio bloqueado: Falta code-style-check.yml" \
                --body "## âš ï¸ Repositorio Bloqueado

Este repositorio ha sido bloqueado porque **no tiene configurado el workflow obligatorio** \`code-style-check.yml\`.

### ðŸ“‹ Acciones requeridas:

1. Crear el archivo \`.github/workflows/code-style-check.yml\`
2. Configurar las validaciones de estilo de cÃ³digo requeridas
3. Una vez creado, las protecciones se mantendrÃ¡n pero permitirÃ¡n merges con el check pasando

### ðŸ”’ Restricciones aplicadas:

- âœ… Se requiere al menos 1 revisiÃ³n aprobada en PRs
- âœ… Se requiere el status check \`code-style-check\` pasando
- âœ… Se descartan aprobaciones obsoletas cuando hay nuevos commits

### ðŸ“š Recursos:

- [DocumentaciÃ³n de GitHub Actions](https://docs.github.com/en/actions)
- Contacta al equipo de DevOps para plantillas

---
*Este issue fue creado automÃ¡ticamente por el workflow de cumplimiento de la organizaciÃ³n.*" \
                --label "compliance,blocked,urgent" \
                2>/dev/null && echo "  âœ… Issue creado" || echo "  âš ï¸  No se pudo crear issue"
            fi
          done
          
          # Generar reporte
          echo "" >> report.md
          echo "## ðŸš¨ Repositorios Bloqueados" >> report.md
          echo "" >> report.md
          
          if [ ${#blocked_repos[@]} -gt 0 ]; then
            for repo in "${blocked_repos[@]}"; do
              echo "- âŒ [$repo](https://github.com/$ORG_NAME/$repo) - **BLOQUEADO**" >> report.md
            done
          else
            echo "*No se bloquearon repositorios nuevos*" >> report.md
          fi
          
          echo "" >> report.md
          echo "## ðŸ“Š Resumen" >> report.md
          echo "" >> report.md
          echo "- **Total de repositorios activos:** $total" >> report.md
          echo "- **Repositorios sin workflow:** $missing" >> report.md
          echo "- **Repositorios bloqueados en esta ejecuciÃ³n:** ${#blocked_repos[@]}" >> report.md
          echo "- **Repositorios ya bloqueados:** ${#already_blocked[@]}" >> report.md
          echo "- **Repositorios conformes:** ${#compliant_repos[@]}" >> report.md
          echo "- **Porcentaje de cumplimiento:** $(( ${#compliant_repos[@]} * 100 / total ))%" >> report.md
          
          echo "" >> report.md
          echo "## âœ… Repositorios Conformes" >> report.md
          echo "" >> report.md
          
          if [ ${#compliant_repos[@]} -gt 0 ]; then
            for repo in "${compliant_repos[@]}"; do
              echo "- âœ… [$repo](https://github.com/$ORG_NAME/$repo)" >> report.md
            done
          fi
          
          # Guardar resultados
          echo "MISSING_COUNT=$missing" >> $GITHUB_ENV
          echo "BLOCKED_COUNT=${#blocked_repos[@]}" >> $GITHUB_ENV
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: repo-blocking-report
          path: report.md
      
      - name: Create Summary Issue
        if: env.BLOCKED_COUNT > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ðŸš¨ Bloqueo Aplicado: ${{ env.BLOCKED_COUNT }} repositorios bloqueados por falta de code-style-check.yml" \
            --body-file report.md \
            --label "workflow-compliance,blocked,urgent"
      
      - name: Send notification
        if: env.BLOCKED_COUNT > 0
        run: |
          echo "========================================="
          echo "ðŸš¨ ALERTA: Se bloquearon ${{ env.BLOCKED_COUNT }} repositorios"
          echo "========================================="
          cat report.md
          echo "========================================="
